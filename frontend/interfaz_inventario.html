<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Inventario</title>
    <link rel="stylesheet" href="estilos/interfaz.css" />
  </head>
  <body>
    <h1>Inventario</h1>

    <section class="controls">
      <div class="row">
        <input
          type="text"
          id="buscar-texto"
          placeholder="Buscar por nombre o descripcion"
          style="flex: 1; min-width: 200px"
        />
        <button id="btn-buscar">Buscar</button>
      </div>
    </section>

    <section>
      <div id="mensaje"></div>
      <h3>Datos del producto</h3>
      <div class="grid">
        <label
          >Codigo
          <input type="text" id="codigo" />
        </label>
        <label
          >Nombre
          <input type="text" id="nombre" />
        </label>
        <label
          >Descripcion
          <input type="text" id="descripcion" />
        </label>
        <label
          >Unidad de medida
          <select id="unidadMedida">
            <option value="">Selecciona unidad</option>
            <option value="unidad">unidad</option>
            <option value="caja">caja</option>
            <option value="paquete">paquete</option>
            <option value="tableta">tableta</option>
            <option value="c치psula">c치psula</option>
            <option value="litro">litro</option>
            <option value="frasco">frasco</option>
          </select>
        </label>
        <label
          >Ubicaci칩n
          <select id="ubicacion">
            <option value="">Selecciona ubicaci칩n</option>
            <option value="A1-EST1">A1-EST1</option>
            <option value="A1-EST2">A1-EST2</option>
            <option value="A2-EST1">A2-EST1</option>
            <option value="A2-EST2">A2-EST2</option>
            <option value="B1-EST1">B1-EST1</option>
            <option value="C1-EST1">C1-EST1</option>
            <option value="C1-EST2">C1-EST2</option>
            <option value="C2-EST1">C2-EST1</option>
            <option value="D1-EST1">D1-EST1</option>
            <option value="E1-EST1">E1-EST1</option>
          </select>
        </label>
        <label
          >Stock actual
          <input type="number" id="stockActual" min="0" />
        </label>
        <label
          >Stock minimo
          <input type="number" id="stockMinimo" min="0" />
        </label>
        <label
          >Stock maximo
          <input type="number" id="stockMaximo" min="0" />
        </label>
        <label
          >Precio venta
          <input type="number" id="precioVenta" min="0" step="0.01" />
        </label>
        <label
          >Precio compra
          <input type="number" id="precioCompra" min="0" step="0.01" />
        </label>
        <label
          >Fecha vencimiento
          <input type="date" id="fechaVencimiento" />
        </label>
        <label
          >ID para editar
          <input
            type="number"
            id="edit-id"
            min="1"
            placeholder="ID existente"
          />
        </label>
      </div>
      <div class="row" style="margin-top: 10px">
        <button id="btn-agregar" class="primary">Agregar</button>
        <button id="btn-editar">Editar</button>
        <button id="btn-eliminar" class="danger">Eliminar</button>
        <button id="btn-limpiar">Limpiar</button>
      </div>
    </section>

    <section>
      <h3>Listado</h3>
      <div
        class="row"
        style="
          justify-content: space-between;
          align-items: center;
          margin-bottom: 6px;
        "
      >
        <div class="row" style="gap: 6px">
          <label style="min-width: 180px">
            Ver productos
            <select id="filtro-nivel-bottom">
            <option value="todos">Stock actual (todos)</option>
            <option value="bajo">Bajos en stock</option>
            </select>
          </label>
        </div>

        <button id="btn-reportar" class="primary">Imprimir</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Codigo</th>
            <th>Nombre</th>
            <th>Descripcion</th>
            <th>Unidad</th>
            <th>Stock actual</th>
            <th>Stock minimo</th>
            <th>Stock maximo</th>
            <th>Precio venta</th>
            <th>Precio compra</th>
            <th>Ubicacion</th>
            <th>Fecha vencimiento</th>
          </tr>
        </thead>
        <tbody id="tabla-body"></tbody>
      </table>
    </section>


    
    <script>
      const API_BASE = "http://localhost:3000/inventario";
      const tablaBody = document.getElementById("tabla-body");
      const mensaje = document.getElementById("mensaje");
      let datosActuales = [];

      
    

      const limpiarTabla = () => {
        tablaBody.innerHTML = "";
      };

      const mostrarMensaje = (texto, tipo = "info") => {
        mensaje.textContent = texto;
        mensaje.style.color = tipo === "error" ? "#b00020" : "#1b5e20";
      };

      const renderTabla = (items = []) => {
        limpiarTabla();
        if (!items.length) {
          mostrarMensaje("Sin datos para mostrar");
          return;
        }
        mensaje.textContent = "";
        items.forEach((item) => {
          const tr = document.createElement("tr");
          if (Number(item.stockActual) < Number(item.stockMinimo))
            tr.classList.add("critico");
          if (
            item.stockMaximo &&
            Number(item.stockActual) > Number(item.stockMaximo)
          )
            tr.classList.add("alto");
          tr.innerHTML = `
          <td>${item.id ?? ""}</td>
          <td>${item.codigo ?? ""}</td>
          <td>${item.nombre ?? ""}</td>
          <td>${item.descripcion ?? ""}</td>
          <td>${item.unidadMedida ?? ""}</td>
          <td>${item.stockActual ?? 0}</td>
          <td>${item.stockMinimo ?? 0}</td>
          <td>${item.stockMaximo ?? ""}</td>
          <td>${item.precioVenta ?? 0}</td>
          <td>${item.precioCompra ?? 0}</td>
          <td>${item.ubicacion ?? ""}</td>
          <td>${
            item.fechaVencimiento
              ? new Date(item.fechaVencimiento).toLocaleDateString()
              : ""
          }</td>
        `;
          tablaBody.appendChild(tr);
        });
      };

      const aplicarFiltrosLocal = () => {
        renderTabla(datosActuales);
      };

      const setDatos = (items = []) => {
        datosActuales = items;
        aplicarFiltrosLocal();
      };

      const apiFetch = async (url, options = {}) => {
        const response = await fetch(url, {
          headers: { "Content-Type": "application/json" },
          ...options,
        });
        const data = await response.json().catch(() => ({}));
        if (!response.ok || data.ok === false)
          throw new Error(data.message || "Operacion fallida");
        return data;
      };

      const getVal = (id) => {
        const el = document.getElementById(id);
        if (!el) return "";
        const v = el.value ?? "";
        return typeof v === "string" ? v.trim() : v;
      };
      const getNum = (id, def = 0) => {
        const v = Number(getVal(id) || def);
        return Number.isFinite(v) ? v : def;
      };

      const buildPayloadFromForm = () => ({
        codigo: getVal("codigo") || null,
        nombre: getVal("nombre"),
        descripcion: getVal("descripcion"),
        unidadMedida: getVal("unidadMedida"),
        ubicacion: getVal("ubicacion"),
        stockActual: getNum("stockActual", 0),
        stockMinimo: getNum("stockMinimo", 0),
        stockMaximo: getNum("stockMaximo", 0),
        precioVenta: getNum("precioVenta", 0),
        precioCompra: getNum("precioCompra", 0),
        fechaVencimiento: getVal("fechaVencimiento") || null,
      });

      const buildUpdatePayloadFromForm = () => {
        const p = {};
        const vCodigo = getVal("codigo");
        const vNombre = getVal("nombre");
        const vDescripcion = getVal("descripcion");
        const vUnidad = getVal("unidadMedida");
        const vUbicacion = getVal("ubicacion");
        const vStockActualRaw = getVal("stockActual");
        const vStockMinimoRaw = getVal("stockMinimo");
        const vStockMaximoRaw = getVal("stockMaximo");
        const vPrecioVentaRaw = getVal("precioVenta");
        const vPrecioCompraRaw = getVal("precioCompra");
        const vFecha = getVal("fechaVencimiento");
        if (vCodigo !== "") p.codigo = vCodigo || null;
        if (vNombre !== "") p.nombre = vNombre;
        if (vDescripcion !== "") p.descripcion = vDescripcion;
        if (vUnidad !== "") p.unidadMedida = vUnidad;
        if (vUbicacion !== "") p.ubicacion = vUbicacion;
        if (vStockActualRaw !== "") p.stockActual = getNum("stockActual", 0);
        if (vStockMinimoRaw !== "") p.stockMinimo = getNum("stockMinimo", 0);
        if (vStockMaximoRaw !== "") p.stockMaximo = getNum("stockMaximo", 0);
        if (vPrecioVentaRaw !== "") p.precioVenta = getNum("precioVenta", 0);
        if (vPrecioCompraRaw !== "") p.precioCompra = getNum("precioCompra", 0);
        if (vFecha !== "") p.fechaVencimiento = vFecha || null;
        return p;
      };

      const limpiarFormulario = () => {
        document.querySelectorAll("input").forEach((inp) => {
          if (inp.type !== "button") inp.value = "";
        });
        const setVal = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.value = val;
        };
        setVal("stockActual", "");
        setVal("stockMinimo", "");
        setVal("stockMaximo", "");
        setVal("precioVenta", "");
        setVal("precioCompra", "");
        setVal("unidadMedida", "");
        setVal("ubicacion", "");
        setVal("fechaVencimiento", "");
      };

      const cargarNivel = async (nivel = "todos") => {
      try {
      let data;
      if (nivel === "bajo") {
      data = await apiFetch(`${API_BASE}/faltantes`);
    } else {
      // Por defecto o "todos"
      data = await apiFetch(`${API_BASE}`);
    }
    setDatos(data.data || []);
  } catch (err) {
    mostrarMensaje(err.message, "error");
  }
};

      // Event listeners
      document
        .getElementById("btn-buscar")
        .addEventListener("click", async () => {
          const term = document.getElementById("buscar-texto").value.trim();
          if (!term)
            return mostrarMensaje("Ingresa un texto de busqueda", "error");
          try {
            const data = await apiFetch(
              `${API_BASE}/buscar?q=${encodeURIComponent(term)}`
            );
            setDatos(data.data || []);
          } catch (err) {
            mostrarMensaje(err.message, "error");
          }
        });

      document
        .getElementById("btn-agregar")
        .addEventListener("click", async () => {
          const payload = buildPayloadFromForm();
          if (!payload.nombre)
            return mostrarMensaje("El nombre es obligatorio", "error");
          try {
            const data = await apiFetch(API_BASE, {
              method: "POST",
              body: JSON.stringify(payload),
            });
            mostrarMensaje(data.message || "Producto creado");
            await cargarNivel(
              document.getElementById("filtro-nivel-bottom").value || "todos"
            );
          } catch (err) {
            mostrarMensaje(err.message, "error");
          }
        });

      document
        .getElementById("btn-editar")
        .addEventListener("click", async () => {
          const id = Number(document.getElementById("edit-id").value);
          if (!id)
            return mostrarMensaje("Ingresa un ID valido para editar", "error");
          const payload = buildUpdatePayloadFromForm();
          if (Object.keys(payload).length === 0)
            return mostrarMensaje("No hay cambios para actualizar", "error");
          try {
            const data = await apiFetch(`${API_BASE}/${id}`, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
            mostrarMensaje(data.message || "Producto actualizado");
            await cargarNivel(
              document.getElementById("filtro-nivel-bottom").value || "todos"
            );
          } catch (err) {
            mostrarMensaje(err.message, "error");
          }
        });

      document
        .getElementById("btn-limpiar")
        .addEventListener("click", limpiarFormulario);

      document
        .getElementById("btn-eliminar")
        .addEventListener("click", async () => {
          const id = Number(document.getElementById("edit-id").value);
          if (!id)
            return mostrarMensaje(
              "Ingresa un ID valido (ID para editar) para eliminar",
              "error"
            );
          try {
            const data = await apiFetch(`${API_BASE}/${id}`, {
              method: "DELETE",
            });
            mostrarMensaje(data.message || "Producto eliminado");
            await cargarNivel(
              document.getElementById("filtro-nivel-bottom").value || "todos"
            );
          } catch (err) {
            mostrarMensaje(err.message, "error");
          }
        });

      document
        .getElementById("btn-reportar")
        .addEventListener("click", () => window.print());


      document
      .getElementById("filtro-nivel-bottom")
      .addEventListener("change", (e) => {
    cargarNivel(e.target.value);
  });


      // Carga inicial
      cargarNivel("todos").catch(() => {});
    </script>
  </body>
</html>
