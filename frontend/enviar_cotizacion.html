<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Enviar Cotizaci贸n</title>
    <link rel="stylesheet" href="estilos/interfaz.css" />
  </head>
  <body>
    <h1>Enviar Cotizaci贸n</h1>
    <section>
      <h3>Proveedores</h3>
      <div id="proveedores-list"></div>
      <div id="mensaje"></div>
    </section>
    <section>
      <h3>Productos seleccionados</h3>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Cantidad</th>
          </tr>
        </thead>
        <tbody id="tabla"></tbody>
      </table>
      <div class="row" style="margin-top:10px">
        <button id="btn-enviar" class="primary">Enviar cotizaci贸n</button>
      </div>
    </section>
    <script>
      const API_PROV = 'http://localhost:3000/cotizaciones/proveedores'
      const API_COTZ = 'http://localhost:3000/cotizaciones/enviar'
      const proveedoresList = document.getElementById('proveedores-list')
      const tabla = document.getElementById('tabla')
      const mensaje = document.getElementById('mensaje')
      let productos = []

      const api = async (url, options={}) => {
        const r = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...options })
        const d = await r.json().catch(()=>({}))
        if (!r.ok || d.ok === false) throw new Error(d.message || 'Error desconocido')
        return d
      }

      const cargarProveedores = async () => {
        const d = await api(API_PROV)
        proveedoresList.innerHTML = ''
        const cont = document.createElement('div')
        cont.className = 'list'
        d.data.forEach(p => {
          const lbl = document.createElement('label')
          lbl.style.display = 'block'
          const chk = document.createElement('input')
          chk.type = 'checkbox'
          chk.setAttribute('data-id', String(p.id))
          lbl.appendChild(chk)
          lbl.append(` ${p.nombre}`)
          cont.appendChild(lbl)
        })
        proveedoresList.appendChild(cont)
      }

      const cargarProductosSeleccionados = async () => {
        const ids = JSON.parse(localStorage.getItem('seleccionCotizacion') || '[]')
        productos = []
        if (!ids.length) return
        const d = await api('http://localhost:3000/inventario')
        const map = new Map((d.data||[]).map(x => [x.id, x]))
        ids.forEach(id => {
          const item = map.get(id)
          if (item) productos.push(item)
        })
        tabla.innerHTML = ''
        productos.forEach(pr => {
          const tr = document.createElement('tr')
          tr.innerHTML = `
            <td>${pr.id}</td>
            <td>${pr.nombre}</td>
            <td><input type="number" min="1" value="1" data-id="${pr.id}" /></td>
          `
          tabla.appendChild(tr)
        })
      }

      document.getElementById('btn-enviar').addEventListener('click', async () => {
        try {
          const proveedorIds = Array.from(document.querySelectorAll('#proveedores-list input[type="checkbox"][data-id]:checked'))
            .map(chk => Number(chk.getAttribute('data-id')))
            .filter(Boolean)
          const items = Array.from(document.querySelectorAll('input[type="number"][data-id]')).map(inp => ({
            productoId: Number(inp.getAttribute('data-id')),
            cantidad: Number(inp.value||1)
          }))
          if (!items.length) { mensaje.textContent = 'Selecciona al menos un producto'; return }
          if (!proveedorIds.length) { mensaje.textContent = 'Selecciona al menos un proveedor'; return }
          if (items.some(it => !Number.isFinite(it.cantidad) || it.cantidad <= 0)) { mensaje.textContent = 'Las cantidades deben ser mayores a cero'; return }
          const d = await api(API_COTZ, { method: 'POST', body: JSON.stringify({ proveedorIds, items }) })
          mensaje.textContent = `Cotizaci贸n enviada. ID: ${d.id}`
          localStorage.removeItem('seleccionCotizacion')
        } catch (e) {
          mensaje.textContent = e.message
        }
      })

      cargarProveedores().catch(()=>{})
      cargarProductosSeleccionados().catch(()=>{})
    </script>
  </body>
  </html>
